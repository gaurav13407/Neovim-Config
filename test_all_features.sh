#!/bin/bash

echo "ğŸ§ª Coplito RAG System - Complete Test Suite"
echo "==========================================="
echo ""

# Colors
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Test counter
TESTS_PASSED=0
TESTS_FAILED=0

# Create test file
cat > /tmp/test_code.py << 'EOF'
def calculate_sum(x, y):
    return x + z  # BUG: z is undefined

def divide(a, b):
    return a / b  # BUG: no zero check

class UserManager:
    def __init__(self):
        self.users = []
    
    def add_user(self, name):
        self.users.append(name)
        return True
EOF

echo "ğŸ“ Created test file: /tmp/test_code.py"
echo ""

# Test 1: Simple chat
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 1: Chat Command (Direct Model Access)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "How to test:"
echo "1. Open test file: nvim /tmp/test_code.py"
echo "2. Press: <leader>gq  (or :GenQwen)"
echo "3. Type query: 'what does this file do?'"
echo "4. Press Enter"
echo ""
echo "Expected result:"
echo "  âœ… Shows notification: 'Gen â†’ Qwen 2.5 Coder 14B...'"
echo "  âœ… Shows context summary with file info"
echo "  âœ… Opens vertical split with AI response"
echo "  âœ… Response mentions Python functions from file"
echo "  âœ… After response, shows 'Continue?' prompt"
echo ""
read -p "Press Enter to continue to next test..."

# Test 2: Fix code with visual selection
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 2: Fix Code (Visual Selection + LSP)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "How to test:"
echo "1. Open test file: nvim /tmp/test_code.py"
echo "2. Wait for LSP to load (1-2 seconds)"
echo "3. Move cursor to line 2 (return x + z)"
echo "4. Press V to enter visual line mode"
echo "5. Press Ctrl+Shift+i"
echo "6. Select: 'ğŸ”§ Fix Code'"
echo "7. Select: 'DeepSeek Coder V2 16B'"
echo "8. Press Enter (or type 'fix this')"
echo ""
echo "Expected result:"
echo "  âœ… Shows context summary"
echo "  âœ… RAG includes LSP error: 'undefined name \"z\"'"
echo "  âœ… Replaces selection with fixed code: 'return x + y'"
echo ""
read -p "Press Enter to continue to next test..."

# Test 3: Review code
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 3: Review Code (Comprehensive Analysis)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "How to test:"
echo "1. Open test file: nvim /tmp/test_code.py"
echo "2. Select divide function (lines 4-5) in visual mode"
echo "3. Press Ctrl+Shift+i"
echo "4. Select: 'ğŸ” Review Code'"
echo "5. Select: 'DeepSeek Coder V2 16B'"
echo "6. Press Enter"
echo ""
echo "Expected result:"
echo "  âœ… Shows context summary"
echo "  âœ… Review mentions: 'No zero check for division'"
echo "  âœ… Suggests: 'Add ZeroDivisionError handling'"
echo "  âœ… Opens in vertical split (doesn't replace)"
echo ""
read -p "Press Enter to continue to next test..."

# Test 4: Explain code
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 4: Explain Code (with Context)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "How to test:"
echo "1. Open test file: nvim /tmp/test_code.py"
echo "2. Select UserManager class (lines 7-13) in visual mode"
echo "3. Press Ctrl+Shift+i"
echo "4. Select: 'ğŸ“ Explain Code'"
echo "5. Select: 'Qwen 2.5 Coder 14B'"
echo "6. Press Enter"
echo ""
echo "Expected result:"
echo "  âœ… Shows context summary"
echo "  âœ… Explanation describes class purpose"
echo "  âœ… Mentions __init__ and add_user methods"
echo "  âœ… Explains self.users list"
echo ""
read -p "Press Enter to continue to next test..."

# Test 5: Context inspection
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 5: Context Inspection Commands"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "How to test:"
echo "1. Open test file: nvim /tmp/test_code.py"
echo "2. Run: :CopiloContext"
echo "3. Run: :CopiloErrors"
echo "4. Run: :CopiloSymbols"
echo ""
echo "Expected result:"
echo "  :CopiloContext"
echo "    âœ… Shows: 'Errors: 2' (z undefined, no zero check)"
echo "    âœ… Shows: 'Symbols: 3-4' (functions + class)"
echo "    âœ… Shows: 'File: /tmp/test_code.py'"
echo ""
echo "  :CopiloErrors"
echo "    âœ… Shows: 'Found 2 error(s) in buffer'"
echo ""
echo "  :CopiloSymbols"
echo "    âœ… Shows: 'Found 3-4 symbols in buffer'"
echo ""
read -p "Press Enter to continue to next test..."

# Test 6: Preview prompt
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 6: Preview RAG Prompt Structure"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "How to test:"
echo "1. Open test file: nvim /tmp/test_code.py"
echo "2. Run: :CopiloPreview"
echo "3. Type query: 'what are the bugs?'"
echo "4. Press Enter"
echo ""
echo "Expected result:"
echo "  âœ… Opens split showing full structured prompt"
echo "  âœ… Contains: [ERROR CONTEXT] section with LSP errors"
echo "  âœ… Contains: [CODE CONTEXT] section with file content"
echo "  âœ… Contains: [USER QUERY] section with your question"
echo "  âœ… Contains: [RESPONSE RULES] section"
echo ""
read -p "Press Enter to continue to next test..."

# Test 7: Enhance code
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 7: Enhance Code (Refactoring)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "How to test:"
echo "1. Open test file: nvim /tmp/test_code.py"
echo "2. Select calculate_sum function (lines 1-2) in visual mode"
echo "3. Press Ctrl+Shift+i"
echo "4. Select: 'âœ¨ Enhance Code'"
echo "5. Select: 'Qwen 2.5 Coder 14B'"
echo "6. Press Enter"
echo ""
echo "Expected result:"
echo "  âœ… Shows context summary"
echo "  âœ… Replaces with enhanced version including:"
echo "      - Type hints (def calculate_sum(x: int, y: int) -> int)"
echo "      - Docstring"
echo "      - Fixed bug (z â†’ y)"
echo "      - Better error handling"
echo ""
read -p "Press Enter to continue to next test..."

# Test 8: Continuation
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 8: Multi-turn Conversation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "How to test:"
echo "1. Open test file: nvim /tmp/test_code.py"
echo "2. Press: <leader>gq"
echo "3. Type: 'what is the calculate_sum function?'"
echo "4. Wait for response"
echo "5. In continuation prompt, type: 'what about divide?'"
echo "6. Wait for response"
echo "7. In continuation prompt, type: 'are there any bugs?'"
echo ""
echo "Expected result:"
echo "  âœ… First response explains calculate_sum"
echo "  âœ… Second response explains divide"
echo "  âœ… Third response mentions both bugs"
echo "  âœ… Can continue indefinitely"
echo "  âœ… Press Esc to exit conversation"
echo ""
read -p "Press Enter to continue to next test..."

# Test 9: All keybindings
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "TEST 9: All Keybindings"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Keybindings to test:"
echo ""
echo "Direct model access (Normal mode):"
echo "  <leader>gq  â†’ Qwen"
echo "  <leader>gd  â†’ DeepSeek"
echo "  <leader>gp  â†’ Phi"
echo ""
echo "Menu-based (Normal mode):"
echo "  <leader>gc  â†’ Model menu â†’ Chat"
echo "  Ctrl+Shift+i â†’ Prompt menu"
echo ""
echo "Code operations (Visual mode):"
echo "  <leader>ge  â†’ Explain"
echo "  <leader>gf  â†’ Fix"
echo "  <leader>gr  â†’ Review"
echo ""
echo "Context inspection (Normal mode):"
echo "  <leader>ci  â†’ Show context"
echo "  <leader>cp  â†’ Preview prompt"
echo "  <leader>ce  â†’ Check errors"
echo "  <leader>cs  â†’ Show symbols"
echo ""
echo "All should work without errors!"
echo ""
read -p "Press Enter to see quick test commands..."

# Quick test commands
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "QUICK TEST COMMANDS"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Copy and paste these into your terminal:"
echo ""
echo "# Open test file"
echo "nvim /tmp/test_code.py"
echo ""
echo "# Then inside Neovim, try these:"
echo ":CopiloContext     # Check what RAG sees"
echo ":CopiloErrors      # Check LSP errors"
echo ":GenQwen           # Start chat with Qwen"
echo ""
echo "# Or use keybindings:"
echo "# <leader>gq â†’ Type: 'summarize this file'"
echo "# Vj â†’ <leader>gf â†’ Fix first function"
echo ""

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Test file ready: /tmp/test_code.py"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Quick start: nvim /tmp/test_code.py"
echo ""
